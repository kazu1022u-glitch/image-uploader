//ç”»åƒä¸€è¦§è¡¨ç¤ºæ©Ÿèƒ½
"use client";

import { useEffect, useState } from "react";
import { supabase } from "@/lib/supabase";

type ImageItem = {
  name: string;
  url: string;
};

export default function DashboardPage() {
  const [images, setImages] = useState<ImageItem[]>([]);
  const [message, setMessage] = useState("");

  useEffect(() => {
    const fetchImages = async () => {
      // ğŸ”‘ ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª
      const {
        data: { user },
      } = await supabase.auth.getUser();

      if (!user) {
        setMessage("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
        return;
      }

      // â‘  ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—
      const { data: files, error } = await supabase.storage
        .from("images")
        .list(user.id);

      if (error) {
        setMessage(error.message);
        return;
      }

      // â‘¡ ç½²åä»˜ãURLç”Ÿæˆ
      const imageList: ImageItem[] = [];

      for (const file of files ?? []) {
        const filePath = `${user.id}/${file.name}`;

        const { data } = await supabase.storage
          .from("images")
          .createSignedUrl(filePath, 60);

        if (data?.signedUrl) {
          imageList.push({
            name: file.name,
            url: data.signedUrl,
          });
        }
      }

      setImages(imageList);
    };

    fetchImages();
  }, []);

  return (
    <div style={{ padding: 20 }}>
      <h1>ç”»åƒä¸€è¦§</h1>

      {message && <p>{message}</p>}

      <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, 200px)", gap: 16 }}>
        {images.map((img) => (
          <img
            key={img.name}
            src={img.url}
            alt={img.name}
            style={{ width: "100%", borderRadius: 8 }}
          />
        ))}
      </div>
    </div>
  );
}
